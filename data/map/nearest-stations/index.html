<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=contain" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://rawgit.com/mapbox/mapbox-gl-leaflet/master/leaflet-mapbox-gl.js"></script>
<style>
body, #map {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
}
#map {
    z-index: 1;
}
.leaflet-control-zoom-in {
    border-top-left-radius: 2px !important;
    border-top-right-radius: 2px !important;
}
.leaflet-control-zoom-out {
    border-bottom-left-radius: 2px !important;
    border-bottom-right-radius: 2px !important;
}
.leaflet-bar {
    box-shadow: none; /* get rid of shadow... */
    border: 1px solid #aaa;
    border-radius: 2px;
}
.leaflet-control-attribution {
    font-size: 6pt !important;
}
#pane {
    margin: 5px;
    /*height: 100vh;*/
    max-width: 23em;
    top: 0;
    /*bottom: 0;*/
    position: absolute;
    z-index: 2;
    background-color: #fff;
    font-size: small;
    font-family: Helvetica, Arial Narrow, sans-serif;
}
.loc_entry {
    margin: 2px;
    margin-top: 5px;
}
table.dirs {
    margin: 1px;
    width: 100%;
    border: 0px solid #ccc;
}
td.r {
    text-align: right;
}

#from_loc_details,
#to_loc_details
{
    font-size: x-small;
}
.ui-accordion-header {
    border: 0 !important;
    border-radius: 1px;
    margin: 0 !important;
}
.ui-accordion-content {
    padding-left: 0;
    padding-right: 0;
    height: auto !important; /* accordion otherwise has weird extra spacing -- why? */
}
th {
    font-size: x-small;
}
#loc_cache_list {
    list-style-type: none;
    padding: 0;
    padding-top: 2px;
    margin: 0;
}
#loc_cache_list li {
    padding: 4px; /* enough space to bnot fat-finger on mobile.. */
}
button#rev_from_and_to {
    padding: 2px;
    margin: 0;
    border: 0;
    font-size: 22px;
    background-color: inherit;
    cursor: pointer;
}
input[type=search] {

    /* get rid of rounded borders */
    border-radius: 0;
    -webkit-appearance: none;

    padding: 3px;
    border: 0;
    border-bottom: 1px solid #ccc;
    font-size: 13px;
}
.dir_line_cycling {
    fill: none;
    stroke: #3388ff;
    stroke-width: 7px;
}
.dir_line_walking {
    fill: none;
    stroke: #3388ff;
    stroke-width: 7px;
    stroke-dasharray: 5,5;
}
</style>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>




<script>

var LocCacheCnt = window.localStorage ? JSON.parse(window.localStorage.getItem('LocCacheCnt') || '{}') : {};
var LocCache = window.localStorage ? JSON.parse(window.localStorage.getItem('LocCache') || '{}') : {};

$(document).ready(function() {
    stations_init();
    loc_cache_render();
    //$('#directions').hide();
    $('#directions').accordion({
        collapsible: true,
        active: 0 // show Locations
    });
});


$(document).ready( function() {

$( "#from_input" ).autocomplete({
    minLength: 1,
    source: function( request, response ) {
        console.log('autocomplete request', JSON.stringify(request));
        do_get_geocode(request.term, response);
    },
    focus: function( event, ui ) {
        $( "#from_input" ).val( ui.item.label );
        return false;
    },
    select: function( event, ui ) {
        $( "#from_input" ).val( ui.item.name );
        station_clicked_push(ui.item);
        return false;
    }
})
.autocomplete( "instance" )._renderItem = function( ul, item ) {
  return $( "<li>" )
    .append( "<div>" + item.name + "<br>" + item.place_name + "</div>" )
    .appendTo( ul );
};

$( "#to_input" ).autocomplete({
    minLength: 1,
    source: function( request, response ) {
        console.log('autocomplete request', JSON.stringify(request));
        do_get_geocode(request.term, response);
    },
    focus: function( event, ui ) {
        $( "#to_input" ).val( ui.item.label );
        return false;
    },
    select: function( event, ui ) {
        $( "#to_input" ).val( ui.item.name );
        station_clicked_push(ui.item);
        return false;
    }
})
.autocomplete( "instance" )._renderItem = function( ul, item ) {
  return $( "<li>" )
    .append( "<div>" + item.name + "<br>" + item.place_name + "</div>" )
    .appendTo( ul );
};

});

</script>


</head>
<body>

<div id="map"></div>

<div id="pane" style="border:1px solid #aaa; border-radius:2px">

    <table>
    <tr>
    <td>

    <div id="from" class="loc_entry">
        <input id="from_input" type="search" placeholder="from" size="27" value="" onfocus="focusto('from');" onchange="do_get_geocode(this.value);">
        <div id="from_loc_details"></div>
    </div>

    <div id="to" class="loc_entry">
        <input id="to_input" type="search" placeholder="to" size="27" value="" onfocus="focusto('to');"  onchange="do_get_geocode(this.value);">
        <div id="to_loc_details"></div>
    </div>

    <td>
        <button id="rev_from_and_to" title="swap 'from' and 'to'" onclick="reverse_from_and_to()">&#x21c5;</button>
    </table>

    <div id="directions">
        <h3>Locations</h3>
        <div style="margin:0;padding:0; max-height:70vh; overflow:scroll">
        <ol id="loc_cache_list"></ol>
        </div>
        <h3>Directions</h3>
        <div style="margin:0;padding:0; max-height: 70vh; overflow:scroll">
            <div id="steps"></div>
        </div>
    </div>
</div>





<script>
var FocusFromOrTo = 'from';

function focusto(f)
{
    if (f == 'from') {
        if (FocusFromOrTo !== 'from') {
            FocusFromOrTo = 'from';
            $('#from_input').focus();
        }
    } else if (f == 'to') {
        if (FocusFromOrTo !== 'to') {
            FocusFromOrTo = 'to';
            $('#to_input').focus();
        }
    } else {
        throw 'unknown focus: ' + f;
    }
    $('#directions').accordion('option', 'active', 0); // locations
}

$(document).ready(function() {
    focusto('from');
});

console.log('script running...');

// old 'n busted
var stationIcon = new L.Icon({
  iconUrl: 'img/bike-blue.png',
  shadowUrl: 'img/marker-shadow.png',
  iconSize: [28, 32],
  iconAnchor: [8, 28],
  popupAnchor: [1, -32],
  shadowSize: [48, 32]
});


var iconWaypoint = new L.Icon({
  iconUrl: 'img/citibike-station-ref/ball2.png',
  iconSize: [9, 9],
  iconAnchor: [4, 4]
  //popupAnchor: [1, -32]
  //shadowUrl: 'img/citibike-station-ref/shadow2.png',
  //shadowSize: [32, 36]
});

var iconStationInactive = new L.Icon({
  iconUrl: 'img/citibike-station-ref/inactive.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActiveEmpty = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-0-4-bikesleft-0.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive04BikesLeft1 = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-0-4-bikesleft-1.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive04BikesLeft2 = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-0-4-bikesleft-2.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive04BikesLeft3 = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-0-4-bikesleft-3.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive04 = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-0-4.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive14 = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-1-4.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive24 = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-2-4.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive34 = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-3-4.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive44 = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-4-4.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive44DocksFull = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-4-4-docksleft-full.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive44DocksLeft1 = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-4-4-docksleft-1.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive44DocksLeft2 = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-4-4-docksleft-2.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});

var iconStationActive44DocksLeft3 = new L.Icon({
  iconUrl: 'img/citibike-station-ref/active-available-4-4-docksleft-3.png',
  iconSize: [26, 32],
  iconAnchor: [13, 32],
  popupAnchor: [1, -32],
  shadowUrl: 'img/citibike-station-ref/shadow2.png',
  shadowSize: [32, 36]
});




var NYC = [
    40.72706363348306,
   -73.99662137031554
];

var GCT = [
     40.751956,
    -73.977718,
];

var map = L.map('map', {
                        center: GCT,
                        zoom: 12,
                        zoomControl: false
                       });
L.control.zoom({position: 'bottomright'}).addTo(map);
L.control.scale().addTo(map);

// test icon
//L.marker(GCT, {icon: iconStationActive44}).addTo(map);



var accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

var mapboxTileLayer = L.tileLayer('https://api.mapbox.com/styles/v1/{acct}/{id}/tiles/256/{z}/{x}/{y}{r}?access_token={accessToken}', {
    maxZoom: 18,
    acct: 'parseerror',
    // XXX: TODO: figure out how to apply/copy the rail-label layer from Outdoor to Light
    //id: 'cjou7knyc3iuv2rmmiw0lnyac', // light -- very clean and cold, but no subway stops, HAS RETINA
    id: 'cjoudjl7b2l7b2rp8nngrm55g', // outdoors, warmer, less clean, but has subway stops, NO RETINA
    accessToken: accessToken,
    detectRetina: false
}).addTo(map);

/*
var gl = L.mapboxGL({
    accessToken: accessToken,
    style: 't'
}).addTo(map);
*/

var DirectionPolyline = null;
var DirectionsObj = {
    raw_dirs: null,
    steps: null,
    latlngs: null,
    total_distance: null,
    total_duration: null
};
function display_directions(from, to, dirs)
{
    process_directions(dirs);
    do_display_directions();
    display_nearby_stations(from, to);
    do_pushstate();
}

function waypoint_push(obj)
{
    console.log('waypoint_push obj', obj);
    var ll = obj.getLatLng();
    var latlng = [ll.lat, ll.lng];
    var origlatlng = obj._data.origlatlng;
    delete WayPoints[origlatlng];
    WayPoints[latlng] = latlng;
    console.log('waypoint_push WayPoints', WayPoints);
}

var shownToCircle = [];

function do_display_directions()
{
    do_display_direction_steps();

    shownToCircle.forEach(function(c) {
        map.removeLayer(c);
    });
    shownToCircle = [];

    // show directions polyline
    // clean up
    if (DirectionPolyline)
        map.removeLayer(DirectionPolyline);
    var latlngs = DirectionsObj.latlngs;
    console.log('latlngs', latlngs);
    DirectionPolyline = L.polyline(latlngs,
                                    {
                                        smoothFactor: 1.0,
                                        className: 'dir_line_cycling'
                                    }).addTo(map);
    console.log('DirectionPolyline', DirectionPolyline);

    latlngs.forEach(function(latlng, i) {

        // draggable waypoint...
        // ref: http://embed.plnkr.co/SJRec3/preview

        var instruction = DirectionsSteps[i].instruction.simplified;
        var m = L.marker(latlng, {
                        icon: iconWaypoint,
                        draggable: true,
                        title: '#' + (i + 1) + ': ' + instruction
                    }).addTo(map);
        m.bindTooltip(instruction);
        m._data = {
            origlatlng: latlng,
            dirlatlngindex: i
        };
        m.on('dragend', function (ev) {
            console.log(ev.type, ev.target.latlng, ev);
            waypoint_push(ev.target);
            do_get_directions();
        });
        console.log('waypoint m', m);
        shownToCircle.push(m);

    });

    if (latlngs.length != 2 || latlngs[0].toString() != latlngs[1].toString()) { // javascript is an embarassing language
        // don't zoom in to a single point, it's disorienting and pointless
        map.fitBounds(DirectionPolyline.getBounds().pad(0.05));
    }
}

function do_pushstate()
{
    // push directions as new state; this way back/forward buttons can cycle through directions
    var title = LocFrom.obj.place_name + ' to ' + LocTo.obj.place_name;
    var params = new URLSearchParams(window.location.search);
    params.set('from', LocFrom.obj.place_name);
    params.set('to', LocTo.obj.place_name);
    Object.keys(WayPoints).forEach(function(k){
        params.set('waypoint', WayPoints[k].toString());
    });
    var connector = !!window.location.search ? '&' : '?';
    var newurl = window.location.origin + window.location.pathname + '?' + params.toString().replace(/=&/, '&');; // XXX: HACK to handle github hosting parameter format...
    console.log('current url', window.location.href.length, window.location.href);
    console.log('new url', newurl.length, newurl);
    var state = {
        title: title,
        LocFrom: LocFrom,
        LocTo: LocTo,
        WayPoints: WayPoints
    };
    document.title = title; // history.pushState title is currently not used by browsers? why?
    if (window.history) {
        console.log('window.history.pushState', state, title, newurl);
        window.history.pushState(state, title, newurl);
    } else {
        console.log('no window.history');
    }
}

function meters_to_miles(meters)
{
    return meters * 0.0006213712;
}

function seconds_format_clock(seconds)
{
    var mins = Math.floor(seconds / 60).toFixed(0);
    var sec = (seconds % 60).toFixed(0);
    var secStr = sec.toString();
    if (secStr.length == 1)
        secStr = '0' + secStr;
    return mins.toString() + ':' + secStr;
}

function simplify_instruction(ins)
{
    //ins = ins.replace(/^Head /g, '');
    ins = ins.replace(/^Continue straight /g, 'Straight ');
    ins = ins.replace(/^Turn left onto /g, 'Left on ');
    ins = ins.replace(/^Turn right onto /g, 'Right on ');
    ins = ins.replace(/^Turn left /g, 'Left ');
    ins = ins.replace(/^Turn right /g, 'Right ');
    ins = ins.replace(/northeast/g, 'NE');
    ins = ins.replace(/northwest/g, 'NW');
    ins = ins.replace(/southeast/g, 'SE');
    ins = ins.replace(/southwest/g, 'SW');
    ins = ins.replace(/Avenue/g, 'Ave');
    ins = ins.replace(/Street/g, 'St');
    ins = ins.replace(/Boulevard/g, 'Blvd');
    ins = ins.replace(/^You have arrived at your destination/g, 'You have arrived');
    return ins;
}

var DirectionsSteps = [];
function do_display_direction_steps()
{
    var steps = DirectionsObj.steps;
    console.log('steps', steps);

    // convert raw-ish steps into displayable data
    DirectionsSteps = [];
    steps.forEach(function(st, i) {
        DirectionsSteps.push({
            number: i + 1,
            instruction: {
                raw: st.maneuver.instruction,
                simplified: simplify_instruction(st.maneuver.instruction)
            },
            distance: {
                raw: st.distance,
                inMeters: meters_to_miles(st.distance).toFixed(1)
            },
            duration: {
                raw: st.duration,
                formatted: seconds_format_clock(st.duration)
            }
        });
    });

    // render
    $('#steps').html('');
    $('#steps').append('<table class=dirs><tr><th colspan=2>' +
        '<div>' +
        '    <span id="dir_dist"></span> <span id="dir_dist_unit"></span>' +
        '    <span id="dir_dur"></span> <span id="dir_dur_unit"></span>' +
        '</div>' +
    '<th>dist');
    DirectionsSteps.forEach(function(st, i) {
        $('#steps table').append('<tr>' +
            '<td>' + st.number +
            '<td>' + st.instruction.simplified +
            '<td class=r>' + st.distance.inMeters
        );
    });

    directions_display_totals();

    $('#directions').accordion('option', 'active', false); // collapse locations and directions
}

function directions_display_totals()
{
    // XXX: TODO: FIXME: separate calculation from display

    var dist_meters = DirectionsObj.total_distance;
    var dist_miles = meters_to_miles(dist_meters);
    var dist = dist_miles.toFixed(1);
    var dist_unit = 'miles';
    $('#dir_dist').text(dist);
    $('#dir_dist_unit').text(dist_unit);

    var dur_seconds = DirectionsObj.total_duration;
    var dur_mins = dur_seconds / 60;
    var dur = dur_mins.toFixed(0);
    var dur_unit = 'mins';
    $('#dir_dur').text(dur);
    $('#dir_dur_unit').text(dur_unit);
}

function process_directions(dirs)
{
    var steps = mapbox_dirs_to_steps(dirs);
    var latlngs = steps.map((s) => s.latlng);
    var total_distance = steps.reduce((acc, item) => acc + item.distance, 0);
    var total_duration = steps.reduce((acc, item) => acc + item.duration, 0);

    DirectionsObj.raw_dirs = dirs;
    DirectionsObj.steps = steps;
    DirectionsObj.latlngs = latlngs;
    DirectionsObj.total_distance = total_distance;
    DirectionsObj.total_duration = total_duration;
}

function mapbox_dirs_to_steps(dirs)
{
    var steps = [];
    // draw new route...
    dirs.routes.forEach(function(rt) {
        rt.legs.forEach(function(leg) {
            leg.steps.forEach(function(step, i) {
                var loc = step.maneuver.location;
                var latlng = [loc[1], loc[0]];
                steps.push(
                    {
                        maneuver: step.maneuver,
                        name: step.name,
                        latlng: latlng,
                        distance: step.distance,
                        duration: step.duration
                    }
                );
            });
        });
    });
    return steps;
}


function display_nearby_stations(from, to)
{
    do_clear_stations();
    do_display_nearby_stations(from);
    do_display_nearby_stations(to);

    // TODO: XXX: FIXME: separate calculation of nearby stations from its display
    /*
    if (FocusFromOrTo == 'from') {
        LocFrom.nearby_stations = nst2;
    } else if (FocusFromOrTo == 'to') {
        LocTo.nearby_stations = nst2;
    }
    */
}

function do_clear_stations()
{
    shownMarkers.forEach(function(m) {
        map.removeLayer(m);
    });
}

function station2obj(st)
{
    // convert native station object into something that matches our locations
    var propst = st.properties.station;
    return {
        place_name: propst.name,
        name: propst.name,
        latlng: rev(st.geometry.coordinates),
        category: 'citibike station',
        maki: 'citibike station',
        station_id: propst.id,
        terminal: propst.terminal
    }
}

function station_display(name)
{
    var st = Stations2[name];
    var stobj = station2obj(st);
    var m = L.marker(stobj.latlng, {icon: station2icon(stobj.name)}).addTo(map);
    m.bindTooltip(station_tooltip(stobj.name));
    m.on('click', function(ev) {
        station_clicked_push(stobj);
    });
    shownMarkers.push(m);
}

function do_display_nearby_stations(obj)
{
    console.log('do_display_nearby_stations', obj);
    var nst = nearest_stations(obj.latlng);
    console.log('nst', nst);
    var stations = nst.map((x) => x[1]);
    stations.forEach(function(st) {
        station_display(st.properties.station.name);
    });
}

function get_directions(from, to)
{
    var fromlatlng = rev(from.latlng);
    var tolatlng = rev(to.latlng);

    var req = new XMLHttpRequest();
    var fromstr = fromlatlng[0] + ',' + fromlatlng[1];
    var tostr = tolatlng[0] + ',' + tolatlng[1];
    var waypts = Object.keys(WayPoints).map(function(k) {
        var latlng = WayPoints[k];
        return latlng[1] + ',' + latlng[0];
    });
    var url = ('https://api.mapbox.com/directions/v5/mapbox/cycling/'
                + fromstr + (waypts.length > 0 ? ';' + waypts.join(';') : '') + ';' + tostr
                + '?steps=true'
                + '&access_token=' + accessToken
               );
    console.log('url', url);
    req.open('GET', url, true);
    req.onreadystatechange = function () {
        switch (req.readyState) {
        case 4:
            switch (req.status) {
            case 200:
                console.log('done', req);
                var dirJson = JSON.parse(req.responseText);
                console.log('dirJson', dirJson);
                display_directions(from, to, dirJson);
                break;
            default:
                console.log('error', req);
                break;
            }
            break;
        default:
            //console.log('readyState', req.readyState, req);
            break;
        }
    }
    req.send();
}

var LocHistory = [];
function loc_history_push(obj)
{
    LocHistory.push(obj);
    console.log('LocHistory', LocHistory);
    if (!!obj.place_name) {
        obj._ts = +Date.now();
        LocCache[obj.place_name] = obj;
        LocCacheCnt[obj.place_name] = (LocCacheCnt[obj.place_name] || 0) + 1;
    }
    if (window.localStorage) {
        window.localStorage.setItem('LocCache', JSON.stringify(LocCache));
        window.localStorage.setItem('LocCacheCnt', JSON.stringify(LocCacheCnt));
    }
    loc_cache_render();
}

function loc_cache_render()
{
    var keys = Object.keys(LocCacheCnt);
    keys = keys.filter((x) => LocCacheCnt[x] >= 1);
    keys = keys.sort((a, b) => LocCacheCnt[b] - LocCacheCnt[a]);
    //keys = keys.slice(0, 25);
    $('#loc_cache_list').empty();
    // special "current location" entry on top
    $('#loc_cache_list').append($('<li>').append($('<a style="cursor:pointer" onclick="geolocateOncePush()">').text('current location')));
    keys.forEach(function(k) {
        $('#loc_cache_list').append($('<li>').append($('<a style="cursor:pointer" onclick="station_clicked_push(LocCache[' + "'" + k + "'" + '])">').text(loc_place_name_shorten(k))));
    });
}

function loc_place_name_shorten(place_name)
{
    place_name = place_name.replace(/, New York [0-9]{5}, United States$/, '');
    place_name = place_name.replace(/, New York$/, '');
    return place_name;
}

var LocFrom = {
    obj: null,
    nearby_stations: []
};
var LocTo = {
    obj: null,
    nearby_stations: []
};
var WayPoints = {};
function station_clicked_push(obj)
{
    console.log('station_clicked_push', obj);

    loc_history_push(obj);

    if (FocusFromOrTo == 'from') {
        LocFrom.obj = obj;
        WayPoints = {};
        update_from_input();
        focusto('to');
    } else if (FocusFromOrTo == 'to') {
        LocTo.obj = obj;
        WayPoints = {};
        update_to_input();
    }
    maybe_look_up_directions();
}

function update_view()
{
}


var _MakiIcon = {
    'ice-cream': 'ðŸ¨',
    'rail': 'ðŸš†',
    'bike': 'ðŸš†',
    'college': 'ðŸŽ“',
    'cafe': '\u2615'
}
function get_icon(obj)
{
    return _MakiIcon[obj.maki];
}

var shownCircle = [];
function update_from_input()
{
    if (shownCircle.length) {
        shownCircle.forEach(function(c) {
            map.removeLayer(c);
        });
    }
    if (LocFrom.obj !== null) {
        shownCircle = [];
        var radius = 1;
        var c = L.circle(LocFrom.obj.latlng, radius).addTo(map);
        c.bindTooltip(LocFrom.obj.name);
        shownCircle.push(c);
        c.bindPopup(LocFrom.obj.name, {autoClose: true}).openPopup();
        //setTimeout(() => map.removeLayer(c._popup), 5000);

        // on first "from", fly to it
        if (LocTo.obj === null) {
            try {
                // on iPhone get: "Error: Set map center and zoom first."
                map.flyTo(LocFrom.obj.latlng);
            } catch (err) {
                console.log('err', err);
            }
        }
    }

    $('#from_input').val(LocFrom.obj.place_name || LocFrom.obj.name || '');
}

function update_to_input()
{
    if (LocTo.obj !== null) {
        var radius = 1;
        var c = L.circle(LocTo.obj.latlng, radius).addTo(map);
        c.bindTooltip(LocTo.obj.name);
        shownToCircle.push(c);
        c.bindPopup(LocTo.obj.name, {autoClose: false}).openPopup();
        setTimeout(() => map.removeLayer(c._popup), 5000);
    }

    $('#to_input').val(LocTo.obj.place_name || LocTo.obj.name || '');
}

function maybe_look_up_directions()
{
    if (LocFrom.obj !== null && LocTo.obj !== null) {
        look_up_directions(LocFrom.obj, LocTo.obj);
    }
}

function show_geocode(geoResults, callback)
{
    var geoSimpler = [];
    console.log('geoResults', geoResults);
    if (geoResults.features) {
        geoResults.features.forEach(function(f) {
            if (true) {
                geoSimpler.push({
                    name: f.text,
                    place_name: f.place_name,
                    address: f.properties.address,
                    tel: f.properties.tel,
                    category: f.properties.category,
                    center: f.center,
                    latlng: rev(f.center),
                    maki: f.properties.maki,
                    geometry: f.geometry
                });
            }
        });
    }
    callback(geoSimpler);

}


function reverse_from_and_to()
{
    var LocTmp = LocFrom;
    LocFrom = LocTo;
    LocTo = LocTmp;

    do_get_directions();
}

function do_get_directions()
{
    update_from_input();
    update_to_input();
    maybe_look_up_directions();
}



var GeoCodeTimer = null;
function do_get_geocode(searchstr, callback)
{
    if (GeoCodeTimer) {
        clearTimeout(GeoCodeTimer);
        GeoCodeTimer = null;
    }
    GeoCodeTimer = setTimeout(get_geocode, 500, searchstr, callback);
}

function get_proximity()
{
    // geocoding search, what location to use as "nearby" so our searches return the most likely results?
    return (LocFrom.obj ? LocFrom.obj.latlng : null)
        || (LocTo.obj ? LocTo.obj.latlng : null)
        || GCT;
}

function get_geocode(searchstr, callback)
{
    var gct='-73.977718,40.751956';
    var prox = get_proximity();
    var proxstr = '' + prox[1] + ',' + prox[0];
    // hardcoded for ~5 borough-ish + a little but of NJ
    var bbox='-74.076861,40.587005,-73.733688,40.858649'
    var searchencoded = encodeURI(searchstr);
    var req = new XMLHttpRequest();
    // ref: https://www.mapbox.com/api-documentation/?language=cURL#search-for-places
    var url = ('https://api.mapbox.com/geocoding/v5/mapbox.places/'
                + searchencoded + '.json'
                + '?proximity= ' + proxstr
                + '&bbox=' + bbox
                + '&access_token=' + accessToken
    );
    req.open('GET', url, true);
    req.onreadystatechange = function () {
        switch (req.readyState) {
        case 4:
            switch (req.status) {
            case 200:
                console.log('done', req);
                show_geocode(JSON.parse(req.responseText), callback);
                break;
            default:
                console.log('error', req);
                break;
            }
            break;
        default:
            //console.log('readyState', req.readyState, req);
            break;
        }
    }
    req.send();
}




function distance(from, to)
{
    return Math.sqrt(Math.pow(from[0] - to[0], 2) + Math.pow(from[1] - to[1], 2));
}

function distance_stations(from)
{
    var dist = Object.keys(Stations2).map((name) =>
        [distance(from, rev(Stations2[name].geometry.coordinates)), Stations2[name]]);
    dist.sort();
    return dist;
}

function nearest_stations(from)
{
    var ds = distance_stations(from);
    var mindist = Math.max(ds[0][0], 0.001);
    console.log('mindist', mindist);
    var cnt_nonemptyish = 0;
    var i = 0;
    // return multiple "close enough" stations
    while (i < ds.length && cnt_nonemptyish < 5)
    {
        if (ds[i][1].properties.station.bikes_available > 3 &&
            ds[i][1].properties.station.docks_available > 3) {
            cnt_nonemptyish++;
        }
        i++;
    }
    return ds.slice(0, i);
}


var Stations2Raw = {};
var Stations2 = {};
function stations_init()
{
    stations_fetch();
}
function stations_fetch()
{
    var url = 'https://layer.bicyclesharing.net/map/v1/nyc/map-inventory';
    $.ajax(url, {
        dataType: 'json',
        timeout: 10000,
        success: function(data, status, xhr) {
            Stations2Raw = data;
            var fstations = Stations2Raw.features.filter((f) => !!(f.properties && f.properties.station));
            Stations2 = {};
            fstations.forEach(function (fst) {
                Stations2[fst.properties.station.name] = fst;
            });
            console.log('Stations2', Stations2);
            handle_url_params(); // handle params, since they might be Stations... XXX: HACK:
        }
    })
}

var IconsStations = {
    empty:              iconStationActiveEmpty,
    active04bikesleft1: iconStationActive04BikesLeft1,
    active04bikesleft2: iconStationActive04BikesLeft2,
    active04bikesleft3: iconStationActive04BikesLeft3,
    active04:           iconStationActive04,
    active14:           iconStationActive14,
    active24:           iconStationActive24,
    active34:           iconStationActive34,
    active44:           iconStationActive44,
    active44docksfull:  iconStationActive44DocksFull,
    active44docksleft1: iconStationActive44DocksLeft1,
    active44docksleft2: iconStationActive44DocksLeft2,
    active44docksleft3: iconStationActive44DocksLeft3,
    comingsoon:         iconStationInactive,
    inactive:           iconStationInactive,
    valet:              iconStationActive44
};

function station2status(name)
{
    var st = Stations2[name];
    var propst = st.properties.station;
    var icon_type = null;
    if (propst.installed === false) {
        icon_type = 'comingsoon';
    } else if (propst.renting === false) {
        icon_type = 'inactive';
    } else if (propst.valet_status === 'available') {
        icon_type = 'valet';
    } else {
        var capacity = propst.capacity;
        var ba = propst.bikes_available;
        var ba_pct = (ba.toFixed(6) / capacity).toFixed(4);
        var da = propst.docks_available;
             if (ba == 0)        icon_type = 'empty';
        else if (ba == 1)        icon_type = 'active04bikesleft1';
        else if (ba == 2)        icon_type = 'active04bikesleft2';
        else if (ba == 3)        icon_type = 'active04bikesleft3';
        else if (da == 0)        icon_type = 'active44docksfull';
        else if (da == 1)        icon_type = 'active44docksleft1';
        else if (da == 2)        icon_type = 'active44docksleft2';
        else if (da == 3)        icon_type = 'active44docksleft3';
        else if (ba <= 5)        icon_type = 'active04';
        else if (ba_pct <  0.60) icon_type = 'active24';
        else if (ba_pct <  0.80) icon_type = 'active34';
        else if (ba_pct >= 0.80) icon_type = 'active44';
        else                     icon_type = 'active14';
    }
    return icon_type;
}

function station2icon(name)
{
    var status = station2status(name);
    var icon = IconsStations[status];
    return icon;
}

function station_tooltip(name)
{
    var st = Stations2[name];
    var propst = st.properties.station;
    var status = null;
    if (propst.installed === false) {
        status = 'comingsoon';
    } else if (propst.renting === false) {
        status = 'inactive';
    } else {
        var capacity = propst.capacity;
        var ba = propst.bikes_available;
        var da = propst.docks_available;
        status = ba + ' bikes, ' + da + ' docks<br>\n' + capacity + ' capacity';
    }
    return name + '<br>\n' + status;
}


var timerShowAll = null;
var shownMarkers = [];

function rev(ll)
{
    return [ll[1], ll[0]];
}

function look_up_directions(from, to)
{
    get_directions(from, to);
}

map.on('moveend', function(ev) {
    console.log(ev.type, ev);
    var c = map.getCenter();
    console.log('c', c);
});

map.on('click', function(ev) {
    console.log(ev.type, ev.latlng);
    map.setView(ev.latlng);
});

map.on('locationfound', function(ev) {
    console.log(ev.type);
});

map.on('locationerror', function(ev) {
    console.log(ev.type);
});

// XXX: TODO: use map.locate (ref: https://leafletjs.com/reference-1.3.4.html#map-methods-for-modifying-map-state)

function geolocateOncePush()
{
    geolocateOnce(geolocatePushCurrentPosition, function(latlng) {
        if (!window.location.search.indexOf('from=')) {
            var latlng = [40.761873, -73.987706];
            map.setView(latlng, 15);
        }
    });
}

function geolocateOnceShow()
{
    geolocateOnce(geolocateShowCurrentPosition);
}

function geolocateOnce(success, error)
{
    if (navigator.geolocation) {
        var opts = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        };
        navigator.geolocation.getCurrentPosition(function(pos) {
            console.log('getCurrentPosition success', pos);
            var lat = pos.coords.latitude;
            var lng = pos.coords.longitude;
            var latlng = [lat, lng];
            success(latlng);
        },
        function(err) {
            console.log('getCurrentPosition error', err);
            if (error) {
                error();
            }
        },
        opts);
    }
}

function geolocatePushCurrentPosition(latlng)
{
    // use current position as a location for directions
    station_clicked_push({name: 'current location', latlng: latlng, address: '', place_name: '', type: 'getCurrentPosition'})
    map.setView(latlng);
}


var geolocateCircle = null;
function geolocateShowCurrentPosition(latlng)
{
    // show current position on map, but don't affect current locations or directions
    if (geolocateCircle) {
        map.removeLayer(geolocateCircle);
    }
    var radius = 50;
    geolocateCircle = L.circle(latlng, radius).addTo(map);
    geolocateCircle.bindTooltip('you');
    geolocateCircle.bindPopup('you');
}

var userGeolocateTimer = null;

function geolocateTrackStart()
{
    userGeolocateTimer = setInterval(geolocateOnceShow, 30 * 1000);
}

function geolocateTrackStop()
{
    if (userGeolocateTimer) {
        clearInterval(userGeolocateTimer);
        userGeolocateTimer = null;
    }
}

function handle_url_params()
{
    // handle current params
    // whew, this was a bit of a mess to figure out, and i'm not confident it'll work all the time...
    // but, it enables us to share urls for testing, so it's helpful today...
    if (window.location.search) {
        var params = new URLSearchParams(window.location.search);
        var downKeyEvent = $.Event('keydown');
        downKeyEvent.keyCode = $.ui.keyCode.DOWN;
        var enterKeyEvent = $.Event('keydown');
        enterKeyEvent.keyCode = $.ui.keyCode.ENTER;
        var from = params.get('from');
        var to = params.get('to');
        var waypoints = params.getAll('waypoint');
        if (from) {
            console.log('param from', from);
            $('#from_input').focus();
            if (from in Stations2) {
                console.log('from in Stations2', station2obj(Stations2[from]));
                $('#from_input').val(from);
                station_clicked_push(station2obj(Stations2[from]));

                if (to) {
                    console.log('param to', to);
                    $('#to_input').focus();
                    if (to in Stations2) {
                        $('#to_input').val(to);
                        station_clicked_push(station2obj(Stations2[to]));
                    } else {
                        $('#to_input').val(to.replace(/^([^,]+(?:,[^,]+)?).*/, '$1'));
                        $('#to_input').one('autocompleteopen', function( event, ui ) {
                            $('#to_input').trigger(downKeyEvent);  // Second downkey highlights first item
                            $('#to_input').trigger(enterKeyEvent);
                        });
                        $('#to_input').autocomplete('search');
                    }
                }

            } else {
                console.log('from not in Stations2');
                $('#from_input').val(from.replace(/^([^,]+(?:,[^,]+)?).*/, '$1'));
                $('#from_input').one('autocompleteopen', function( event, ui ) {
                    $('#from_input').trigger(downKeyEvent);  // Second downkey highlights first item
                    $('#from_input').trigger(enterKeyEvent);

                    if (to) {
                        console.log('param to', to);
                        $('#to_input').focus();
                        if (to in Stations2) {
                            console.log('to in Stations2', station2obj(Stations2[to]));
                            $('#to_input').val(to);
                            station_clicked_push(station2obj(Stations2[to]));
                        } else {
                            console.log('to not in Stations2');
                            $('#to_input').val(to.replace(/^([^,]+(?:,[^,]+)?).*/, '$1'));
                            $('#to_input').one('autocompleteopen', function( event, ui ) {
                                $('#to_input').trigger(downKeyEvent);  // Second downkey highlights first item
                                $('#to_input').trigger(enterKeyEvent);
                            });
                            $('#to_input').autocomplete('search');
                        }
                    }

                });
                $('#from_input').autocomplete('search');
            }
        }
        WayPoints = {};
        waypoints.forEach(function(wp) {
            var ll = wp.split(/,/).map((l) => +l);
            WayPoints[ll] = ll;
        });
        if (from || to) {
            do_get_directions();
        }
    }
}

$(document).ready(function() {
    geolocateOncePush();
});

window.addEventListener('popstate', function(ev) {
    console.log('url changed', ev);
    if (ev.type == 'popstate') {
        var state = ev.state;
        console.log('handling popstate...', ev.state);
        // now go "back" (restore previous state)
        document.title = state.title;
        LocFrom        = state.LocFrom;
        LocTo          = state.LocTo;
        WayPoints      = state.WayPoints;
        do_get_directions();
    } else {
        console.log('unsupported url change type..');
    }
});

document.addEventListener('visibilitychange', function() {
    if (document.visibilityState == 'visible') {
        console.log('visible');
        geolocateTrackStart();
    } else if (document.visibilityState == 'hidden') {
        console.log('hidden');
        geolocateTrackStop();
    } else {
        console.log('unhandled visibilityState', document.visibilityState);
    }
}, false);

</script>
</body>
</html>
